<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO Tags -->
    <title>Oneiro: AI Dream Analyzer & Journal</title>
    <meta name="description" content="Unlock the secrets of your subconscious with Oneiro, an AI-powered dream analyzer and personal dream journal. Get spiritual and scientific interpretations.">
    <meta name="keywords" content="dream analyzer, dream interpreter, dream journal, dream meaning, ai dream analysis, spiritual dream meaning, scientific dream analysis">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 700px;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal Styles */
        #historyModal.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen py-8">
    <div class="container bg-white w-full mx-4 p-6 sm:p-8 rounded-2xl shadow-lg relative">
        
        <!-- Header with History Button -->
        <header class="flex justify-between items-center pb-4 border-b border-gray-200">
            <h1 class="text-3xl font-bold text-gray-800">Oneiro</h1>
            <button id="historyBtn" class="text-sm bg-gray-100 text-gray-700 font-medium py-2 px-4 rounded-lg hover:bg-gray-200 transition">
                Dream History
            </button>
        </header>

        <div class="text-center mt-6">
            <h2 class="text-xl font-semibold text-gray-700">AI Dream Analyzer & Journal</h2>
            <p class="text-gray-600 mt-2">Unlock the secrets of your subconscious. Get AI-powered dream analysis.</p>
        </div>

        <div class="mt-8">
            <label for="dreamInput" class="block text-sm font-medium text-gray-700 mb-2">Describe your dream in detail here:</label>
            <textarea id="dreamInput" rows="5" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Example: I had a dream that I was flying above the clouds..."></textarea>
        </div>

        <div class="mt-6 text-center">
            <button onclick="getInterpretation()" id="submitBtn" class="bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-transform transform hover:scale-105">
                Find Meaning
            </button>
        </div>
        
        <!-- Disclaimer -->
        <p class="text-center text-xs text-gray-500 mt-4">Disclaimer: AI-generated interpretations are based on patterns and data. They are not a substitute for professional psychological or medical advice.</p>

        <div id="result" class="mt-8">
            <!-- Results will be displayed here -->
        </div>

        <div class="text-center text-xs text-gray-400 mt-8 border-t border-gray-200 pt-4">
            <p>&copy; 2025 Vedang Soni. All rights reserved.</p>
        </div>
    </div>

    <!-- History Modal -->
    <div id="historyModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-lg w-full max-w-lg max-h-[80vh] flex flex-col">
            <header class="flex justify-between items-center p-4 border-b">
                <h2 class="text-xl font-bold text-gray-800">Dream History</h2>
                <button id="closeModalBtn" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
            </header>
            <div id="historyList" class="p-6 overflow-y-auto">
                <!-- History items will be injected here by JS -->
            </div>
        </div>
    </div>

    <script>
        const dreamInput = document.getElementById('dreamInput');
        const resultDiv = document.getElementById('result');
        const submitBtn = document.getElementById('submitBtn');
        
        // Modal elements
        const historyBtn = document.getElementById('historyBtn');
        const historyModal = document.getElementById('historyModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const historyList = document.getElementById('historyList');

        // --- History Modal Logic ---
        historyBtn.addEventListener('click', () => {
            renderHistory();
            historyModal.classList.remove('hidden');
        });

        closeModalBtn.addEventListener('click', () => {
            historyModal.classList.add('hidden');
        });

        // Close modal if clicking outside the content
        historyModal.addEventListener('click', (e) => {
            if (e.target === historyModal) {
                historyModal.classList.add('hidden');
            }
        });

        // --- Local Storage Logic ---
        const HISTORY_KEY = 'oneiroDreamHistory';

        function loadHistory() {
            return JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
        }

        function saveHistory(newEntry) {
            let history = loadHistory();
            history.unshift(newEntry); // Add new entry to the beginning
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
        }

        function renderHistory() {
            let history = loadHistory();
            if (history.length === 0) {
                historyList.innerHTML = '<p class="text-gray-500">No dreams saved yet.</p>';
                return;
            }

            historyList.innerHTML = history.map(entry => `
                <div class="flex items-center justify-between p-4 border rounded-lg mb-3">
                    <div class="flex-grow cursor-pointer" data-id="${entry.id}">
                        <h3 class="font-semibold text-blue-600">${entry.title}</h3>
                        <p class="text-sm text-gray-500">${entry.date}</p>
                    </div>
                    <button class="ml-4 text-gray-400 hover:text-red-600 transition p-1 rounded-full" data-delete-id="${entry.id}" title="Delete this entry">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            `).join('');

            // Add click listeners to history items
            historyList.querySelectorAll('[data-id]').forEach(item => {
                item.addEventListener('click', () => {
                    const id = item.getAttribute('data-id');
                    const history = loadHistory();
                    const entry = history.find(e => e.id == id);
                    if (entry) {
                        showSavedResult(entry);
                        historyModal.classList.add('hidden');
                        window.scrollTo(0, document.body.scrollHeight); // Scroll to result
                    }
                });
            });

            // Add click listeners for delete buttons
            historyList.querySelectorAll('[data-delete-id]').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); // Prevent the view click
                    const id = button.getAttribute('data-delete-id');
                    deleteHistoryItem(id);
                });
            });
        }

        function deleteHistoryItem(id) {
            let history = loadHistory();
            history = history.filter(entry => entry.id != id);
            localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            renderHistory(); // Re-render the list immediately
        }
        
        // --- Core API Logic ---
        async function getInterpretation() {
            const apiKey = "AIzaSyCWUir05ATgwpAVP8tH6tbhVQAYBgO4_dA";
            const dream = dreamInput.value.trim();

            if (!dream) {
                alert('Please enter your dream description.');
                return;
            }

            resultDiv.innerHTML = '<div class="loader"></div>';
            submitBtn.disabled = true;
            submitBtn.classList.add('opacity-50', 'cursor-not-allowed');

            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            // Updated prompt to ask for a title
            const prompt = `
                Analyze the following dream: "${dream}".

                1.  First, create a short, catchy title for this dream (max 5 words). Start this title with the marker "## TITLE".
                2.  Second, provide a spiritual analysis. Start with "## SPIRITUAL ANALYSIS".
                3.  Third, provide a scientific/psychological analysis. Start with "## SCIENTIFIC ANALYSIS".

                Provide the entire response in English. Keep the language simple.
            `;

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || `API Error: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.candidates && data.candidates.length > 0 && data.candidates[0].content.parts[0].text) {
                    const content = data.candidates[0].content.parts[0].text;
                    // New function to parse, save, and display
                    parseAndShowResult(content, dream);
                } else {
                    throw new Error('Unexpected API response format.');
                }

            } catch (error) {
                displayError(error);
            } finally {
                submitBtn.disabled = false;
                submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function parseAndShowResult(content, dreamText) {
            let title = "Untitled Dream";
            let spiritual = "Analysis not available.";
            let scientific = "Analysis not available.";

            try {
                if (content.includes("## TITLE")) {
                    title = content.split("## TITLE")[1].split("## SPIRITUAL ANALYSIS")[0].trim();
                }
                if (content.includes("## SPIRITUAL ANALYSIS")) {
                    spiritual = content.split("## SPIRITUAL ANALYSIS")[1].split("## SCIENTIFIC ANALYSIS")[0].trim();
                }
                if (content.includes("## SCIENTIFIC ANALYSIS")) {
                    scientific = content.split("## SCIENTIFIC ANALYSIS")[1].trim();
                }
            } catch (e) {
                console.error("Error parsing AI response:", e);
                // Fallback: Show raw content if parsing fails
                scientific = content; 
            }

            const newEntry = {
                id: Date.now(),
                date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
                title: title.replace(/\*\*/g, ''), // Remove markdown from title
                dream: dreamText,
                spiritual: spiritual,
                scientific: scientific
            };

            // Save to local storage
            saveHistory(newEntry);
            
            // Display on page
            showSavedResult(newEntry);
        }

        function showSavedResult(entry) {
            // This function now displays a history entry object
            resultDiv.innerHTML = `
                <div class="p-4 sm:p-5 rounded-xl border bg-gray-50 mb-5">
                    <h2 class="text-xl font-bold text-gray-800 mb-3">Spiritual Analysis</h2>
                    <p class="text-gray-700 whitespace-pre-wrap">${entry.spiritual.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>')}</p>
                </div>
                <div class="p-4 sm:p-5 rounded-xl border bg-gray-50">
                    <h2 class="text-xl font-bold text-gray-800 mb-3">Scientific/Psychological Analysis</h2>
                    <p class="text-gray-700 whitespace-pre-wrap">${entry.scientific.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>')}</p>
                </div>
                <div class="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                    <h4 class="font-semibold text-blue-800">Your Original Dream:</h4>
                    <p class="text-gray-700 italic mt-2 whitespace-pre-wrap">"${entry.dream}"</p>
                </div>
            `;
        }
        
        function displayError(error) {
             resultDiv.innerHTML = `<div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg">
                                       <p class="font-bold">An error occurred!</p>
                                       <p>${error.message}</p>
                                       <p class="mt-3 font-semibold text-sm">Possible Solutions:</p>
                                       <ul class="list-disc list-inside text-sm mt-1">
                                           <li>This error is often due to Google Cloud project configuration.</li>
                                           <li>Please ensure the "Generative Language API" is enabled in your Google Cloud project.</li>
                                           <li>Also, check if billing is enabled for your project, as it might be required for some models.</li>
                                       </ul>
                                   </div>`;
        }

    </script>
</body>
</html>


